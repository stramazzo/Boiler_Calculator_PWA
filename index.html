<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="description" content="Boiler Calculator PWA - Cinque calcolatori specializzati">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Boiler Calculator">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    <meta name="apple-touch-icon-precomposed" content="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon.png">
    
    <title>Boiler Calculator PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="icon" type="image/x-icon" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Roboto, sans-serif;
            background: linear-gradient(180deg, #f8fafb 0%, #eef2f5 100%);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            color: #1a1a1a;
        }

        .container {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
            padding: 32px;
            max-width: 800px;
            width: 100%;
            margin: auto;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #1a1a1a;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .menu-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25), 0 2px 8px rgba(118, 75, 162, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .menu-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .menu-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.35), 0 4px 15px rgba(118, 75, 162, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .menu-item:hover:before {
            opacity: 1;
        }

        .menu-item h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            line-height: 1.4;
        }

        .menu-item p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.875rem;
            line-height: 1.5;
            font-weight: 400;
        }

        .calculator {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 600px;
            width: 100%;
            margin: auto;
        }

        .calculator.active {
            display: block;
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .calculator-title {
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .back-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .input-group input[aria-invalid="true"] {
            border-color: #e74c3c;
            border-width: 2px;
        }
        
        .input-group input[aria-invalid="true"]:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .input-with-unit {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-with-unit input {
            flex: 1;
        }

        .input-with-unit select {
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            min-width: 80px;
        }

        .input-with-unit select:focus {
            outline: none;
            border-color: #3498db;
        }

        .app-icon {
            width: 32px;
            height: 32px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .result {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .results-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .results-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3rem;
        }

        .result-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .result-group:last-child {
            border-bottom: none;
        }

        .result-group label {
            font-weight: bold;
            color: #495057;
            flex: 1;
            margin-right: 15px;
        }

        .result-value {
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(116, 185, 255, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.4);
            background: linear-gradient(135deg, #0984e3 0%, #006ba6 100%);
        }

        .action-btn.reset,
        .action-btn.save,
        .action-btn.load {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .calculate-btn {
            background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
            color: #2d3436;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.5);
            background: linear-gradient(45deg, #81ecec 0%, #fd79a8 100%);
        }

        .simple-calculator {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 350px;
            width: 100%;
            margin: auto;
        }

        .simple-calculator.active {
            display: block;
        }

        .display {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: right;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .previous-operand {
            font-size: 1.2rem;
            color: #bdc3c7;
            margin-bottom: 5px;
            min-height: 1.5rem;
        }

        .current-operand {
            font-size: 2.5rem;
            font-weight: bold;
            word-wrap: break-word;
            word-break: break-all;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            border-radius: 15px;
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #2c3e50;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.operator {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(108, 92, 231, 0.3);
        }

        .btn.operator:hover {
            background: linear-gradient(135deg, #5f3dc4 0%, #6c5ce7 100%);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
        }

        .btn.equals {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.3);
        }

        .btn.equals:hover {
            background: linear-gradient(135deg, #00a085 0%, #00b894 100%);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }

        .btn.clear {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(253, 121, 168, 0.3);
        }

        .btn.clear:hover {
            background: linear-gradient(135deg, #e84393 0%, #f39c12 100%);
            box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
        }

        .btn.delete {
            background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(250, 177, 160, 0.3);
        }

        .btn.delete:hover {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            box-shadow: 0 6px 20px rgba(250, 177, 160, 0.4);
        }

        .btn.span-2 {
            grid-column: span 2;
        }

        /* Temperature Probe Calculator Styles */
        .result-box {
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .result-box h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.3rem;
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .result-label {
            font-weight: bold;
            color: #495057;
            font-size: 1rem;
        }

        .result-value {
            background: #2c3e50;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 100px;
            text-align: center;
        }

        .result-unit {
            color: #6b7280;
            font-weight: 500;
            font-size: 1rem;
        }

        .result-info {
            margin-top: 15px;
            padding: 12px;
            background: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .result-info p {
            color: #1976D2;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }

        .reset-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .reset-btn {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(253, 121, 168, 0.3);
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 121, 168, 0.4);
            background: linear-gradient(135deg, #e84393 0%, #f39c12 100%);
        }

        @supports (-webkit-touch-callout: none) {
            body {
                /* Allow scrolling on iOS */
                position: relative;
                width: 100%;
                min-height: 100vh;
                overflow-y: auto;
            }
            
            .calculator, .simple-calculator {
                /* Ensure calculator can scroll */
                max-height: none;
                overflow-y: auto;
                padding-bottom: 50px; /* Add extra padding for better scrolling */
            }
            
            /* Ensure all content is scrollable */
            .calculator.active, .simple-calculator.active {
                overflow-y: auto;
                max-height: none;
            }
        }

        @media (max-width: 600px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .calculator-title {
                font-size: 1.5rem;
            }
            
            /* Improve scrolling on mobile devices */
            .calculator, .simple-calculator {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            
            .results-section {
                margin-bottom: 30px; /* Add space at bottom for better scrolling */
            }
        }

        @media screen and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }
        
        body.dark-mode .container {
            background: #2c3e50;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .header h1 {
            color: #ffffff;
        }
        
        body.dark-mode .header p {
            color: #b0b0b0;
        }
        
        body.dark-mode .calculator,
        body.dark-mode .simple-calculator {
            background: rgba(44, 62, 80, 0.95);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .input-group label {
            color: #e0e0e0;
        }
        
        body.dark-mode .input-group input,
        body.dark-mode .input-group select {
            background: #34495e;
            color: #ffffff;
            border-color: #4a5568;
        }
        
        body.dark-mode .input-group input:focus,
        body.dark-mode .input-group select:focus {
            border-color: #3498db;
            background: #3d5468;
        }
        
        body.dark-mode .input-group input[aria-invalid="true"] {
            border-color: #e74c3c;
        }
        
        body.dark-mode .results-section {
            background: #34495e;
            border-color: #4a5568;
        }
        
        body.dark-mode .results-section h3 {
            color: #ffffff;
        }
        
        body.dark-mode .result-group label {
            color: #b0b0b0;
        }
        
        body.dark-mode .result-value {
            background: #1a252f;
            color: #ffffff;
        }
        
        body.dark-mode .result-box {
            background: #34495e;
            border-color: #4a5568;
        }
        
        body.dark-mode .result-box h3 {
            color: #ffffff;
        }
        
        body.dark-mode .result-item {
            background: #2c3e50;
            border-color: #4a5568;
        }
        
        body.dark-mode .result-info {
            background: #2c3e50;
            border-left-color: #3498db;
        }
        
        body.dark-mode .result-info p {
            color: #b0d4f1;
        }
        
        body.dark-mode .calculator-title {
            color: #ffffff;
        }
        
        body.dark-mode .calculator-header {
            border-bottom-color: #4a5568;
        }
        
        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            font-size: 1.2rem;
            color: white;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .dark-mode-toggle:active {
            transform: scale(0.95);
        }
        
        body.dark-mode .dark-mode-toggle {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        /* Export Button */
        .export-btn {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.3);
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
            background: linear-gradient(135deg, #00a085 0%, #00b894 100%);
        }
        
        body.dark-mode .export-btn {
            background: linear-gradient(135deg, #00a085 0%, #00b894 100%);
        }
        
        body.dark-mode .export-btn:hover {
            background: linear-gradient(135deg, #008b75 0%, #00a085 100%);
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Toggle dark mode" title="Dark Mode">
        <span id="dark-mode-icon">üåô</span>
    </button>
    
    <!-- Main Menu -->
    <div class="container" id="main-menu" role="main">
        <div class="header">
            <h1>
                <svg class="app-icon" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <!-- Met√† sinistra: Tazzina da caff√® -->
                    <defs>
                        <clipPath id="leftHalf">
                            <rect x="0" y="0" width="16" height="32"/>
                        </clipPath>
                        <clipPath id="rightHalf">
                            <rect x="16" y="0" width="16" height="32"/>
                        </clipPath>
                    </defs>
                    
                    <!-- Tazzina (met√† sinistra) -->
                    <g clip-path="url(#leftHalf)">
                        <!-- Corpo tazzina -->
                        <path d="M4 8 L12 8 C12 8 12 20 12 22 C12 24 10 26 8 26 C6 26 4 24 4 22 Z" fill="#8B4513" stroke="#654321" stroke-width="1"/>
                        <!-- Manico -->
                        <path d="M12 12 C14 12 15 13 15 15 C15 17 14 18 12 18" fill="none" stroke="#654321" stroke-width="1.5"/>
                        <!-- Caff√® -->
                        <ellipse cx="8" cy="10" rx="3.5" ry="1" fill="#2F1B14"/>
                        <!-- Vapore -->
                        <path d="M6 6 C6 5 6 4 6 4" stroke="#e0e0e0" stroke-width="1" stroke-linecap="round"/>
                        <path d="M8 5 C8 4 8 3 8 3" stroke="#e0e0e0" stroke-width="1" stroke-linecap="round"/>
                        <path d="M10 6 C10 5 10 4 10 4" stroke="#e0e0e0" stroke-width="1" stroke-linecap="round"/>
                    </g>
                    
                    <!-- Calcolatrice (met√† destra) -->
                    <g clip-path="url(#rightHalf)">
                        <!-- Corpo calcolatrice -->
                        <rect x="17" y="6" width="12" height="20" rx="2" fill="#2c3e50" stroke="#1a252f" stroke-width="1"/>
                        <!-- Display -->
                        <rect x="18.5" y="8" width="9" height="3" rx="0.5" fill="#000" stroke="#333" stroke-width="0.5"/>
                        <text x="27.5" y="10.5" font-family="monospace" font-size="2" fill="#00ff00" text-anchor="end">123</text>
                        
                        <!-- Pulsanti -->
                        <!-- Riga 1 -->
                        <rect x="19" y="12.5" width="1.8" height="1.8" rx="0.3" fill="#95a5a6"/>
                        <rect x="21.1" y="12.5" width="1.8" height="1.8" rx="0.3" fill="#95a5a6"/>
                        <rect x="23.2" y="12.5" width="1.8" height="1.8" rx="0.3" fill="#95a5a6"/>
                        <rect x="25.3" y="12.5" width="1.8" height="1.8" rx="0.3" fill="#e74c3c"/>
                        
                        <!-- Riga 2 -->
                        <rect x="19" y="14.6" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="21.1" y="14.6" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="23.2" y="14.6" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="25.3" y="14.6" width="1.8" height="1.8" rx="0.3" fill="#3498db"/>
                        
                        <!-- Riga 3 -->
                        <rect x="19" y="16.7" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="21.1" y="16.7" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="23.2" y="16.7" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="25.3" y="16.7" width="1.8" height="1.8" rx="0.3" fill="#3498db"/>
                        
                        <!-- Riga 4 -->
                        <rect x="19" y="18.8" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="21.1" y="18.8" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="23.2" y="18.8" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="25.3" y="18.8" width="1.8" height="1.8" rx="0.3" fill="#27ae60"/>
                        
                        <!-- Riga 5 -->
                        <rect x="19" y="20.9" width="4" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="23.2" y="20.9" width="1.8" height="1.8" rx="0.3" fill="#ecf0f1"/>
                        <rect x="25.3" y="20.9" width="1.8" height="1.8" rx="0.3" fill="#27ae60"/>
                    </g>
                </svg>
                Boiler Calculator
            </h1>
            <p>Select the calculator you want to use</p>
        </div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="showCalculator('heating')" role="button" tabindex="0" aria-label="Open heating time calculator" onkeypress="if(event.key==='Enter') showCalculator('heating')">
                <h3>üî• Heating Time Calculator</h3>
                <p>Calculate heating time</p>
            </div>
            
            <div class="menu-item" onclick="showCalculator('power')" role="button" tabindex="0" aria-label="Open power calculator" onkeypress="if(event.key==='Enter') showCalculator('power')">
                <h3>‚ö° Power Calculator</h3>
                <p>Calculate heating power</p>
            </div>
            
            <div class="menu-item" onclick="showCalculator('cooling')" role="button" tabindex="0" aria-label="Open cooling time calculator" onkeypress="if(event.key==='Enter') showCalculator('cooling')">
                <h3>‚ùÑÔ∏è Cooling Time Calculator</h3>
                <p>Calculate cooling time</p>
            </div>
            
            <div class="menu-item" onclick="showCalculator('brewing')" role="button" tabindex="0" aria-label="Open brewing loss calculator" onkeypress="if(event.key==='Enter') showCalculator('brewing')">
                <h3>‚òï Brewing Loss Calculator</h3>
                <p>Calculate losses during preparation</p>
            </div>
            
            <div class="menu-item" onclick="showCalculator('simple')" role="button" tabindex="0" aria-label="Open simple calculator" onkeypress="if(event.key==='Enter') showCalculator('simple')">
                <h3>üî¢ Simple Calculator</h3>
                <p>Standard calculator for basic operations</p>
            </div>
            
            <div class="menu-item" onclick="showCalculator('tempprobe')" role="button" tabindex="0" aria-label="Open temperature probe calculator" onkeypress="if(event.key==='Enter') showCalculator('tempprobe')">
                <h3>üå°Ô∏è Temp Probe Calculator</h3>
                <p>NTC PTC Calculator</p>
            </div>
        </div>
    </div>

    <!-- Heating Time Calculator -->
    <div class="calculator" id="heating-calculator" role="main" aria-label="Heating time calculator">
        <div class="calculator-header">
            <div class="calculator-title">üî• Heating Time Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="input-group">
            <label for="ht_initial_temp">Initial Temperature (¬∞C)</label>
            <input type="number" id="ht_initial_temp" value="50.0" step="0.1" 
                   aria-label="Initial temperature in degrees Celsius"
                   aria-describedby="ht_initial_temp_desc"
                   aria-required="true"
                   min="-273" max="1000">
            <span id="ht_initial_temp_desc" class="sr-only">Enter the initial water temperature, between -273¬∞C and 1000¬∞C</span>
        </div>
        
        <div class="input-group">
            <label for="ht_target_temp">Target Temperature (¬∞C)</label>
            <input type="number" id="ht_target_temp" value="70.0" step="0.1"
                   aria-label="Target temperature in degrees Celsius"
                   aria-describedby="ht_target_temp_desc"
                   aria-required="true"
                   min="-273" max="1000">
            <span id="ht_target_temp_desc" class="sr-only">Enter the desired target temperature, must be greater than the initial temperature</span>
        </div>
        
        <div class="input-group">
            <label for="ht_water_volume">Water Volume (L)</label>
            <input type="number" id="ht_water_volume" value="5.0" step="0.1"
                   aria-label="Water volume in liters"
                   aria-describedby="ht_water_volume_desc"
                   aria-required="true"
                   min="0.001" max="10000">
            <span id="ht_water_volume_desc" class="sr-only">Enter the water volume in liters, between 0.001L and 10000L</span>
        </div>
        
        <div class="input-group">
            <label for="ht_stainless_steel_volume">Stainless Steel Volume</label>
            <div class="input-with-unit">
                <input type="number" id="ht_stainless_steel_volume" value="0.001" step="0.0001"
                       aria-label="Stainless steel volume"
                       aria-describedby="ht_stainless_steel_volume_desc"
                       aria-required="true"
                       min="0.0000000001" max="1000000000">
                <select id="ht_stainless_steel_volume_unit" onchange="convertVolume('ht')"
                        aria-label="Unit of measurement for stainless steel volume">
                    <option value="m3">m¬≥</option>
                    <option value="cm3">cm¬≥</option>
                </select>
            </div>
            <span id="ht_stainless_steel_volume_desc" class="sr-only">Enter the stainless steel volume</span>
        </div>
        
        <div class="input-group">
            <label for="ht_heater_power">Heater Power (W)</label>
            <input type="number" id="ht_heater_power" value="2000.0" step="1"
                   aria-label="Heater power in Watts"
                   aria-describedby="ht_heater_power_desc"
                   aria-required="true"
                   min="1" max="100000">
            <span id="ht_heater_power_desc" class="sr-only">Enter the heater power in Watts, between 1W and 100000W</span>
        </div>
        
        <div class="input-group">
            <label>
                <input type="checkbox" id="ht_include_dissipation" onchange="toggleDissipationFields('ht')">
                Include dissipation loss
            </label>
        </div>
        
        <div id="ht_dissipation_group" style="display: none;">
            <div class="input-group">
                <label for="ht_room_temp">Ambient Temperature (¬∞C)</label>
                <input type="number" id="ht_room_temp" value="20.0" step="0.1"
                       aria-label="Ambient temperature in degrees Celsius"
                       aria-describedby="ht_room_temp_desc"
                       min="-273" max="100">
                <span id="ht_room_temp_desc" class="sr-only">Enter the ambient temperature in degrees Celsius</span>
            </div>
            
            <div class="input-group">
                <label for="ht_heat_transfer_coeff">Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)</label>
                <input type="number" id="ht_heat_transfer_coeff" value="15.0" step="0.1"
                       aria-label="Heat transfer coefficient in Watts per square meter per degree Celsius"
                       aria-describedby="ht_heat_transfer_coeff_desc"
                       min="0.1" max="1000">
                <span id="ht_heat_transfer_coeff_desc" class="sr-only">Enter the heat transfer coefficient</span>
            </div>
            
            <div class="input-group">
                <label for="ht_surface_area">External Surface Area</label>
                <div class="input-with-unit">
                    <input type="number" id="ht_surface_area" value="0.5" step="0.01"
                           aria-label="External surface area"
                           aria-describedby="ht_surface_area_desc"
                           min="0.0000000001" max="1000000000">
                    <select id="ht_surface_area_unit" onchange="convertSurfaceArea('ht')"
                            aria-label="Unit of measurement for surface area">
                        <option value="m2">m¬≤</option>
                        <option value="cm2">cm¬≤</option>
                    </select>
                </div>
                <span id="ht_surface_area_desc" class="sr-only">Enter the external surface area</span>
            </div>
        </div>
        
        <div class="action-buttons" role="group" aria-label="Parameter actions">
            <button class="action-btn reset" onclick="resetToDefault('heating')" 
                    aria-label="Reset parameters to default values">Reset to Default</button>
            <button class="action-btn save" onclick="saveParameters('heating')"
                    aria-label="Save current parameters">Save Parameters</button>
            <button class="action-btn load" onclick="loadParameters('heating')"
                    aria-label="Load saved parameters">Load Parameters</button>
        </div>
        
        <button class="calculate-btn" onclick="calculateHeatingTime()" aria-label="Calculate heating time">Calculate Heating Time</button>
        
        <div class="results-section" role="region" aria-label="Calculation results">
            <h3>Results:</h3>
            <div class="result-group">
                <label>Estimated Heating Time:</label>
                <div class="result-value" id="heating-result" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>
            <div class="result-group">
                <label>Time in Seconds (s):</label>
                <div class="result-value" id="heating-seconds" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>
            <button class="export-btn" onclick="exportHeatingResults()" aria-label="Export results in CSV format">
                üì• Export CSV
            </button>
        </div>
    </div>

    <!-- Power Calculator -->
    <div class="calculator" id="power-calculator" role="main" aria-label="Power calculator">
        <div class="calculator-header">
            <div class="calculator-title">‚ö° Power Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="input-group">
            <label for="pc_initial_temp">Initial Temperature (¬∞C)</label>
            <input type="number" id="pc_initial_temp" value="50.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="pc_target_temp">Target Temperature (¬∞C)</label>
            <input type="number" id="pc_target_temp" value="70.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="pc_water_volume">Water Volume (L)</label>
            <input type="number" id="pc_water_volume" value="5.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="pc_stainless_steel_volume">Stainless Steel Volume</label>
            <div class="input-with-unit">
                <input type="number" id="pc_stainless_steel_volume" value="0.001" step="0.0001"
                       min="0.0000000001" max="1000000000">
                <select id="pc_stainless_steel_volume_unit" onchange="convertVolume('pc')">
                    <option value="m3">m¬≥</option>
                    <option value="cm3">cm¬≥</option>
                </select>
            </div>
        </div>
        
        <div class="input-group">
            <label for="pc_time_required">Time Required (seconds)</label>
            <input type="number" id="pc_time_required" value="300.0" step="1">
        </div>
        
        <div class="input-group">
            <label>
                <input type="checkbox" id="pc_include_dissipation" onchange="toggleDissipationFields('pc')">
                Include dissipation loss
            </label>
        </div>
        
        <div id="pc_dissipation_group" style="display: none;">
            <div class="input-group">
                <label for="pc_room_temp">Ambient Temperature (¬∞C)</label>
                <input type="number" id="pc_room_temp" value="20.0" step="0.1">
            </div>
            
            <div class="input-group">
                <label for="pc_heat_transfer_coeff">Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)</label>
                <input type="number" id="pc_heat_transfer_coeff" value="15.0" step="0.1">
            </div>
            
            <div class="input-group">
                <label for="pc_surface_area">External Surface Area</label>
                <div class="input-with-unit">
                    <input type="number" id="pc_surface_area" value="0.5" step="0.01"
                           min="0.0000000001" max="1000000000">
                    <select id="pc_surface_area_unit" onchange="convertSurfaceArea('pc')">
                        <option value="m2">m¬≤</option>
                        <option value="cm2">cm¬≤</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn reset" onclick="resetToDefault('power')">Reset to Default</button>
            <button class="action-btn save" onclick="saveParameters('power')">Save Parameters</button>
            <button class="action-btn load" onclick="loadParameters('power')">Load Parameters</button>
        </div>
        
        <button class="calculate-btn" onclick="calculatePower()" aria-label="Calculate required power">Calculate Required Power</button>
        
        <div class="results-section" role="region" aria-label="Power calculation results">
            <h3>Results:</h3>
            <div class="result-group">
                <label>Total Power Required (W/h):</label>
                <div class="result-value" id="total-power"></div>
            </div>
            <div class="result-group">
                <label>Power to Water (W/h):</label>
                <div class="result-value" id="power-to-water"></div>
            </div>
            <div class="result-group">
                <label>Power to Stainless Steel (W/h):</label>
                <div class="result-value" id="power-to-steel"></div>
            </div>
            <div class="result-group">
                <label>Power Lost to Environment (W/h):</label>
                <div class="result-value" id="power-lost"></div>
            </div>
            <div class="result-group">
                <label>Required Heater Power (W):</label>
                <div class="result-value" id="instant-power"></div>
            </div>
            <button class="export-btn" onclick="exportPowerResults()" aria-label="Esporta risultati in formato CSV">
                üì• Export CSV
            </button>
        </div>
    </div>

    <!-- Cooling Time Calculator -->
    <div class="calculator" id="cooling-calculator" role="main" aria-label="Cooling time calculator">
        <div class="calculator-header">
            <div class="calculator-title">‚ùÑÔ∏è Cooling Time Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="input-group">
            <label for="ct_initial_temp">Initial Temperature (¬∞C)</label>
            <input type="number" id="ct_initial_temp" value="70.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="ct_final_temp">Final Temperature (¬∞C)</label>
            <input type="number" id="ct_final_temp" value="50.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="ct_water_volume">Water Volume (L)</label>
            <input type="number" id="ct_water_volume" value="5.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="ct_stainless_steel_volume">Stainless Steel Volume</label>
            <div class="input-with-unit">
                <input type="number" id="ct_stainless_steel_volume" value="0.001" step="0.0001"
                       min="0.0000000001" max="1000000000">
                <select id="ct_stainless_steel_volume_unit" onchange="convertVolume('ct')">
                    <option value="m3">m¬≥</option>
                    <option value="cm3">cm¬≥</option>
                </select>
            </div>
        </div>
        
        <div class="input-group">
            <label for="ct_room_temp">Ambient Temperature (¬∞C)</label>
            <input type="number" id="ct_room_temp" value="20.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="ct_heat_transfer_coeff">Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)</label>
            <input type="number" id="ct_heat_transfer_coeff" value="15.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="ct_surface_area">External Surface Area</label>
            <div class="input-with-unit">
                <input type="number" id="ct_surface_area" value="0.5" step="0.01"
                       min="0.0000000001" max="1000000000">
                <select id="ct_surface_area_unit" onchange="convertSurfaceArea('ct')">
                    <option value="m2">m¬≤</option>
                    <option value="cm2">cm¬≤</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn reset" onclick="resetToDefault('cooling')">Reset to Default</button>
            <button class="action-btn save" onclick="saveParameters('cooling')">Save Parameters</button>
            <button class="action-btn load" onclick="loadParameters('cooling')">Load Parameters</button>
        </div>
        
        <button class="calculate-btn" onclick="calculateCoolingTime()" aria-label="Calculate cooling time">Calculate Cooling Time</button>
        
        <div class="results-section" role="region" aria-label="Cooling calculation results">
            <h3>Results:</h3>
            <div class="result-group">
                <label>Estimated Cooling Time:</label>
                <div class="result-value" id="cooling-result"></div>
            </div>
            <div class="result-group">
                <label>Time in Seconds (s):</label>
                <div class="result-value" id="cooling-seconds"></div>
            </div>
            <div class="result-group">
                <label>Total Power Lost (W/h):</label>
                <div class="result-value" id="cooling-total-power-lost"></div>
            </div>
            <div class="result-group">
                <label>Total Power Lost Water (W/h):</label>
                <div class="result-value" id="cooling-total-power-lost-water"></div>
            </div>
            <div class="result-group">
                <label>Total Power Lost Stainless Steel (W/h):</label>
                <div class="result-value" id="cooling-total-power-lost-steel"></div>
            </div>
            <button class="export-btn" onclick="exportCoolingResults()" aria-label="Esporta risultati in formato CSV">
                üì• Export CSV
            </button>
        </div>
    </div>

    <!-- Brewing Loss Calculator -->
    <div class="calculator" id="brewing-calculator" role="main" aria-label="Brewing loss calculator">
        <div class="calculator-header">
            <div class="calculator-title">‚òï Brewing Loss Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="input-group">
            <label for="br_initial_temp">Initial Temperature (¬∞C)</label>
            <input type="number" id="br_initial_temp" value="95.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="br_water_volume">Water Volume (L)</label>
            <input type="number" id="br_water_volume" value="5.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="br_stainless_steel_volume">Stainless Steel Volume</label>
            <div class="input-with-unit">
                <input type="number" id="br_stainless_steel_volume" value="0.001" step="0.0001">
                <select id="br_stainless_steel_volume_unit" onchange="convertVolume('br')">
                    <option value="m3">m¬≥</option>
                    <option value="cm3">cm¬≥</option>
                </select>
            </div>
        </div>
        
        <div class="input-group">
            <label for="br_applied_heater_power">Applied Heater Power (W)</label>
            <input type="number" id="br_applied_heater_power" value="0.0" step="1">
        </div>
        
        <div class="input-group">
            <label for="br_brewing_flow_rate">Brewing Flow Rate (ml/s)</label>
            <input type="number" id="br_brewing_flow_rate" value="5.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="br_brewing_time_duration">Brewing Time Duration (s)</label>
            <input type="number" id="br_brewing_time_duration" value="20.0" step="0.1">
        </div>
        
        <div class="input-group">
            <label for="br_plumbing_temperature">Brewing Plumbing Temperature (¬∞C)</label>
            <input type="number" id="br_plumbing_temperature" value="20.0" step="0.1">
        </div>
        
        <div class="action-buttons">
            <button class="action-btn reset" onclick="resetToDefault('brewing')">Reset to Default</button>
            <button class="action-btn save" onclick="saveParameters('brewing')">Save Parameters</button>
            <button class="action-btn load" onclick="loadParameters('brewing')">Load Parameters</button>
        </div>
        
        <button class="calculate-btn" onclick="calculateBrewingLoss()" aria-label="Calculate losses during preparation">Calculate Brewing Loss</button>
        
        <div class="results-section" role="region" aria-label="Brewing loss calculation results">
            <h3>Results:</h3>
            <div class="result-group">
                <label>Boiler Final Temperature (¬∞C):</label>
                <div class="result-value" id="final-temp"></div>
            </div>
            <div class="result-group">
                <label>Boiler Temperature Loss (¬∞C):</label>
                <div class="result-value" id="lost-temp"></div>
            </div>
            <div class="result-group">
                <label>Average Brewed Temperature (¬∞C):</label>
                <div class="result-value" id="average-brewed-temp"></div>
            </div>
            <div class="result-group">
                <label>Initial Brewed Temperature (¬∞C):</label>
                <div class="result-value" id="initial-brewed-temp"></div>
            </div>
            <div class="result-group">
                <label>Final Brewed Temperature (¬∞C):</label>
                <div class="result-value" id="final-brewed-temp"></div>
            </div>
            <div class="result-group">
                <label>Total Brewed Volume (L):</label>
                <div class="result-value" id="total-brewed-volume"></div>
            </div>
            <div class="result-group">
                <label>Brewing Energy Loss (W):</label>
                <div class="result-value" id="brewing-energy-loss"></div>
            </div>
            <button class="export-btn" onclick="exportBrewingResults()" aria-label="Esporta risultati in formato CSV">
                üì• Export CSV
            </button>
        </div>
    </div>

    <!-- Simple Calculator -->
    <div class="simple-calculator" id="simple-calculator" role="main" aria-label="Simple calculator">
        <div class="calculator-header">
            <div class="calculator-title">üî¢ Simple Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="display">
            <div class="previous-operand" id="previous-operand"></div>
            <div class="current-operand" id="current-operand">0</div>
        </div>
        
        <div class="buttons">
            <button class="btn clear" onclick="clearAll()">AC</button>
            <button class="btn delete" onclick="deleteLast()">DEL</button>
            <button class="btn operator" onclick="chooseOperation('%')">%</button>
            <button class="btn operator" onclick="chooseOperation('√∑')">√∑</button>
            
            <button class="btn" onclick="appendNumber('7')">7</button>
            <button class="btn" onclick="appendNumber('8')">8</button>
            <button class="btn" onclick="appendNumber('9')">9</button>
            <button class="btn operator" onclick="chooseOperation('√ó')">√ó</button>
            
            <button class="btn" onclick="appendNumber('4')">4</button>
            <button class="btn" onclick="appendNumber('5')">5</button>
            <button class="btn" onclick="appendNumber('6')">6</button>
            <button class="btn operator" onclick="chooseOperation('-')">-</button>
            
            <button class="btn" onclick="appendNumber('1')">1</button>
            <button class="btn" onclick="appendNumber('2')">2</button>
            <button class="btn" onclick="appendNumber('3')">3</button>
            <button class="btn operator" onclick="chooseOperation('+')">+</button>
            
            <button class="btn" onclick="appendNumber('0')">0</button>
            <button class="btn" onclick="appendDecimal()">.</button>
            <button class="btn equals span-2" onclick="compute()">=</button>
        </div>
    </div>

    <!-- Temperature Probe Calculator -->
    <div class="calculator" id="tempprobe-calculator" role="main" aria-label="Temperature probe calculator">
        <div class="calculator-header">
            <div class="calculator-title">üå°Ô∏è Temp Probe Calculator</div>
            <button class="back-btn" onclick="showMenu()" aria-label="Back to main menu">‚Üê Menu</button>
        </div>
        
        <div class="input-group">
            <label for="tp_input_type">Input Type</label>
            <select id="tp_input_type" onchange="toggleInputFields()"
                    aria-label="Input type: temperature or resistance"
                    aria-describedby="tp_input_type_desc">
                <option value="temperature">Temperature ‚Üí Resistance</option>
                <option value="resistance">Resistance ‚Üí Temperature</option>
            </select>
            <span id="tp_input_type_desc" class="sr-only">Select whether you want to enter temperature or resistance</span>
        </div>
        
        <div class="input-group">
            <label for="tp_probe_type">Probe Type</label>
            <select id="tp_probe_type" onchange="onProbeTypeChange()"
                    aria-label="Temperature probe type"
                    aria-describedby="tp_probe_type_desc">
                <option value="ntc3k3">NTC 3.3kŒ© @ 100¬∞C</option>
                <option value="pt1000">PT1000 (1000Œ© @ 0¬∞C)</option>
            </select>
            <span id="tp_probe_type_desc" class="sr-only">Select the type of temperature probe to use</span>
        </div>
        
        <div class="input-group" id="tp_limits" style="display: none;">
            <label>Valid Range</label>
            <div style="background: #e8f4fd; padding: 8px; border-radius: 4px; border-left: 4px solid #2196F3; font-size: 14px; color: #1976D2;">
                <span id="tp_limits_text">Select probe type to see valid range</span>
            </div>
        </div>
        
        <div class="input-group" id="temp_input_group">
            <label for="tp_temperature">Temperature (¬∞C)</label>
                            <input type="number" id="tp_temperature" placeholder="Enter temperature value" step="0.1">
        </div>
        
        <div class="input-group" id="resistance_input_group" style="display: none;">
            <label for="tp_resistance">Resistance (Œ©)</label>
            <input type="number" id="tp_resistance" placeholder="Enter resistance value" step="0.01" min="0">
        </div>
        
        <button class="calculate-btn" onclick="calculateTempProbe();" aria-label="Calculate temperature or resistance">Calculate</button>
        
        <div class="result-box" id="tempprobe-result" style="display: none; margin-top: 20px; margin-bottom: 30px;" role="region" aria-label="Temperature probe calculation result">
            <h3>Result</h3>
            <div class="result-item">
                <span class="result-label" id="tp_result_label" aria-label="Result label">Resistance:</span>
                <span class="result-value" id="tp_result_value" role="status" aria-live="polite" aria-atomic="true">-</span>
                <span class="result-unit" id="tp_result_unit" aria-label="Unit√† di misura">Œ©</span>
            </div>
            
            <!-- Result Information -->
            <div class="result-info" role="status" aria-live="polite">
                <p id="tp_result_info">Enter values above to calculate</p>
            </div>
            
            <button class="export-btn" onclick="exportTempProbeResults()" aria-label="Esporta risultati in formato CSV" style="margin-top: 15px;">
                üì• Export CSV
            </button>
        </div>
        
        <div class="reset-container">
            <button class="reset-btn" onclick="resetTempProbe()" aria-label="Reset all temperature probe calculator fields">Reset</button>
        </div>
    </div>

    <!-- Load individual probe data files -->
    <script src="ntc3k3.js"></script>
    <script src="pt1000.js"></script>
    <!-- Load main data handler -->
    <script src="temp_probe_data_new.js"></script>
        <script>
        // Initialize limits display on page load
        const inputType = document.getElementById('tp_input_type').value;
        const probeType = document.getElementById('tp_probe_type').value;
        const probeInfo = window.getProbeData(probeType);
        updateLimitsDisplay(probeInfo, inputType);
        </script>
        
        <script>
        // Unit conversion functions
        function convertSurfaceArea(prefix) {
            const input = document.getElementById(prefix + '_surface_area');
            const unit = document.getElementById(prefix + '_surface_area_unit').value;
            const currentValue = parseFloat(input.value) || 0;
            
            // Get current unit from a data attribute or assume m2 if not set
            const currentUnit = input.dataset.currentUnit || 'm2';
            
            if (currentUnit !== unit) {
                let convertedValue;
                if (currentUnit === 'm2' && unit === 'cm2') {
                    // Convert m¬≤ to cm¬≤
                    convertedValue = currentValue * 10000;
                } else if (currentUnit === 'cm2' && unit === 'm2') {
                    // Convert cm¬≤ to m¬≤
                    convertedValue = currentValue / 10000;
                } else {
                    convertedValue = currentValue;
                }
                
                input.value = convertedValue.toFixed(currentUnit === 'm2' && unit === 'cm2' ? 0 : 6);
                input.dataset.currentUnit = unit;
            }
        }

        function convertVolume(prefix) {
            const input = document.getElementById(prefix + '_stainless_steel_volume');
            const unit = document.getElementById(prefix + '_stainless_steel_volume_unit').value;
            const currentValue = parseFloat(input.value) || 0;
            
            // Get current unit from a data attribute or assume m3 if not set
            const currentUnit = input.dataset.currentUnit || 'm3';
            
            if (currentUnit !== unit) {
                let convertedValue;
                if (currentUnit === 'm3' && unit === 'cm3') {
                    // Convert m¬≥ to cm¬≥
                    convertedValue = currentValue * 1000000;
                } else if (currentUnit === 'cm3' && unit === 'm3') {
                    // Convert cm¬≥ to m¬≥
                    convertedValue = currentValue / 1000000;
                } else {
                    convertedValue = currentValue;
                }
                
                input.value = convertedValue.toFixed(currentUnit === 'm3' && unit === 'cm3' ? 0 : 9);
                input.dataset.currentUnit = unit;
            }
        }

        // Function to normalize values to standard units (m¬≤ and m¬≥) for calculations
        function getNormalizedSurfaceArea(prefix) {
            const input = document.getElementById(prefix + '_surface_area');
            const unit = document.getElementById(prefix + '_surface_area_unit').value;
            const value = parseFloat(input.value) || 0;
            
            if (unit === 'cm2') {
                return value / 10000; // Convert cm¬≤ to m¬≤
            }
            return value; // Already in m¬≤
        }

        function getNormalizedVolume(prefix) {
            const input = document.getElementById(prefix + '_stainless_steel_volume');
            const unit = document.getElementById(prefix + '_stainless_steel_volume_unit').value;
            const value = parseFloat(input.value) || 0;
            
            if (unit === 'cm3') {
                return value / 1000000; // Convert cm¬≥ to m¬≥
            }
            return value; // Already in m¬≥
        }

        // Default values from calculator_config.ini
        const defaultValues = {
            // Heating Time Calculator
            ht_initial_temp: 50.0,
            ht_target_temp: 70.0,
            ht_water_volume: 5.0,
            ht_heater_power: 2000.0,
            ht_room_temp: 20.0,
            ht_heat_transfer_coeff: 15.0,
            ht_surface_area: 0.5,
            ht_stainless_steel_volume: 0.001,
            
            // Power Calculator
            pc_initial_temp: 50.0,
            pc_target_temp: 70.0,
            pc_water_volume: 5.0,
            pc_stainless_steel_volume: 0.001,
            pc_time_required: 300.0,
            pc_room_temp: 20.0,
            pc_heat_transfer_coeff: 15.0,
            pc_surface_area: 0.5,
            
            // Cooling Time Calculator
            ct_initial_temp: 70.0,
            ct_final_temp: 50.0,
            ct_water_volume: 5.0,
            ct_room_temp: 20.0,
            ct_heat_transfer_coeff: 15.0,
            ct_surface_area: 0.5,
            ct_stainless_steel_volume: 0.001,
            
            // Brewing Loss Calculator
            br_initial_temp: 95.0,
            br_water_volume: 5.0,
            br_stainless_steel_volume: 0.001,
            br_applied_heater_power: 0.0,
            br_brewing_flow_rate: 5.0,
            br_brewing_time_duration: 20.0,
            br_plumbing_temperature: 20.0
        };

        // Navigation functions
        function showMenu() {
            document.getElementById('main-menu').style.display = 'block';
            document.querySelectorAll('.calculator, .simple-calculator').forEach(calc => {
                calc.classList.remove('active');
            });
            // Show dark mode toggle on main menu
            const toggle = document.querySelector('.dark-mode-toggle');
            if (toggle) toggle.style.display = 'flex';
        }

        function showCalculator(type) {
            document.getElementById('main-menu').style.display = 'none';
            document.querySelectorAll('.calculator, .simple-calculator').forEach(calc => {
                calc.classList.remove('active');
            });
            
            if (type === 'simple') {
                document.getElementById('simple-calculator').classList.add('active');
            } else if (type === 'tempprobe') {
                document.getElementById('tempprobe-calculator').classList.add('active');
            } else {
                document.getElementById(type + '-calculator').classList.add('active');
            }
            // Hide dark mode toggle when in calculator view
            const toggle = document.querySelector('.dark-mode-toggle');
            if (toggle) toggle.style.display = 'none';
        }

        // Parameter management functions
        function resetToDefault(calculatorType) {
            const prefix = calculatorType === 'heating' ? 'ht_' : 
                          calculatorType === 'power' ? 'pc_' : 
                          calculatorType === 'cooling' ? 'ct_' : 'br_';
            
            Object.keys(defaultValues).forEach(key => {
                if (key.startsWith(prefix)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = defaultValues[key];
                    }
                }
            });
            
            // Reset unit selectors to default values (meters)
            const surfaceAreaUnitSelect = document.getElementById(prefix + 'surface_area_unit');
            if (surfaceAreaUnitSelect) {
                surfaceAreaUnitSelect.value = 'm2';
                // Reset the dataset to ensure proper conversion tracking
                const surfaceAreaInput = document.getElementById(prefix + 'surface_area');
                if (surfaceAreaInput) {
                    surfaceAreaInput.dataset.currentUnit = 'm2';
                }
            }
            
            const volumeUnitSelect = document.getElementById(prefix + 'stainless_steel_volume_unit');
            if (volumeUnitSelect) {
                volumeUnitSelect.value = 'm3';
                // Reset the dataset to ensure proper conversion tracking
                const volumeInput = document.getElementById(prefix + 'stainless_steel_volume');
                if (volumeInput) {
                    volumeInput.dataset.currentUnit = 'm3';
                }
            }
            
            showNotification('Parameters reset to default values', 'success');
        }

        function saveParameters(calculatorType) {
            const prefix = calculatorType === 'heating' ? 'ht_' : 
                          calculatorType === 'power' ? 'pc_' : 
                          calculatorType === 'cooling' ? 'ct_' : 'br_';
            
            const params = {};
            Object.keys(defaultValues).forEach(key => {
                if (key.startsWith(prefix)) {
                    const input = document.getElementById(key);
                    if (input) {
                        params[key] = parseFloat(input.value) || 0;
                    }
                }
            });
            
            // Save unit selections for surface area and volume
            const surfaceAreaUnitSelect = document.getElementById(prefix + 'surface_area_unit');
            if (surfaceAreaUnitSelect) {
                params[prefix + 'surface_area_unit'] = surfaceAreaUnitSelect.value;
            }
            
            const volumeUnitSelect = document.getElementById(prefix + 'stainless_steel_volume_unit');
            if (volumeUnitSelect) {
                params[prefix + 'stainless_steel_volume_unit'] = volumeUnitSelect.value;
            }
            
            localStorage.setItem('savedParams_' + calculatorType, JSON.stringify(params));
            showNotification('Parameters saved successfully', 'success');
        }

        function loadParameters(calculatorType) {
            const savedParams = localStorage.getItem('savedParams_' + calculatorType);
            if (savedParams) {
                const params = JSON.parse(savedParams);
                Object.keys(params).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = params[key];
                    }
                });
                showNotification('Parameters loaded successfully', 'success');
            } else {
                showNotification('No saved parameters found', 'info');
            }
        }

        function showNotification(message, type = 'success') {
            // Create a notification with type support
            const notification = document.createElement('div');
            const colors = {
                success: { bg: '#27ae60', icon: '‚úì' },
                error: { bg: '#e74c3c', icon: '‚ö†' },
                info: { bg: '#3498db', icon: '‚Ñπ' },
                warning: { bg: '#f39c12', icon: '‚ö†' }
            };
            const config = colors[type] || colors.success;
            
            // Convert hex to rgba with 60% opacity (0.4 alpha)
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            notification.className = 'notification';
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${hexToRgba(config.bg, 0.4)};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 10000;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
                backdrop-filter: blur(10px);
            `;
            notification.innerHTML = `
                <span style="font-size: 1.2em;">${config.icon}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, type === 'error' ? 5000 : 3000);
        }
        
        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Enhanced input validation helper with accessibility support
        function validateCalculatorInputs(prefix, validations) {
            const errors = [];
            let firstInvalidInput = null;
            
            for (const [key, {min, max, required = true, customMessage}] of Object.entries(validations)) {
                const input = document.getElementById(prefix + key);
                if (!input) continue;
                
                const value = parseFloat(input.value);
                const label = input.previousElementSibling?.textContent || key.replace(/_/g, ' ');
                
                // Clear previous error state
                input.setAttribute('aria-invalid', 'false');
                input.removeAttribute('aria-describedby');
                const existingError = document.getElementById(prefix + key + '_error');
                if (existingError) existingError.remove();
                
                if (required && (isNaN(value) || input.value === '' || input.value.trim() === '')) {
                    const errorMsg = customMessage || `${label} is required`;
                    errors.push(errorMsg);
                    markInputAsInvalid(input, prefix + key, errorMsg);
                    if (!firstInvalidInput) firstInvalidInput = input;
                } else if (!isNaN(value)) {
                    if (min !== undefined && value < min) {
                        const errorMsg = customMessage || `${label} must be at least ${min}`;
                        errors.push(errorMsg);
                        markInputAsInvalid(input, prefix + key, errorMsg);
                        if (!firstInvalidInput) firstInvalidInput = input;
                    } else if (max !== undefined && value > max) {
                        const errorMsg = customMessage || `${label} must be at most ${max}`;
                        errors.push(errorMsg);
                        markInputAsInvalid(input, prefix + key, errorMsg);
                        if (!firstInvalidInput) firstInvalidInput = input;
                    } else {
                        markInputAsValid(input, prefix + key);
                    }
                }
            }
            
            if (errors.length > 0) {
                showNotification(errors[0], 'error');
                // Focus first invalid input for accessibility
                if (firstInvalidInput) {
                    setTimeout(() => firstInvalidInput.focus(), 100);
                }
                return false;
            }
            return true;
        }
        
        function markInputAsInvalid(input, inputId, errorMessage) {
            input.style.borderColor = '#e74c3c';
            input.style.borderWidth = '2px';
            input.setAttribute('aria-invalid', 'true');
            
            // Create error message element
            const errorId = inputId + '_error';
            let errorElement = document.getElementById(errorId);
            if (!errorElement) {
                errorElement = document.createElement('span');
                errorElement.id = errorId;
                errorElement.className = 'error-message';
                errorElement.setAttribute('role', 'alert');
                errorElement.setAttribute('aria-live', 'polite');
                errorElement.style.cssText = `
                    display: block;
                    color: #e74c3c;
                    font-size: 0.85rem;
                    margin-top: 4px;
                    font-weight: 500;
                `;
                input.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = errorMessage;
            input.setAttribute('aria-describedby', errorId);
        }
        
        function markInputAsValid(input, inputId) {
            input.style.borderColor = '#27ae60';
            input.style.borderWidth = '2px';
            input.setAttribute('aria-invalid', 'false');
            
            const errorId = inputId + '_error';
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
            input.removeAttribute('aria-describedby');
            
            // Reset border after 2 seconds
            setTimeout(() => {
                input.style.borderColor = '';
                input.style.borderWidth = '';
            }, 2000);
        }
        
        // Real-time validation on input
        function setupRealTimeValidation(inputId, validation) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            input.addEventListener('blur', () => {
                const value = parseFloat(input.value);
                const prefix = inputId.substring(0, inputId.lastIndexOf('_') + 1);
                const key = inputId.substring(inputId.lastIndexOf('_') + 1);
                
                if (validation.required && (isNaN(value) || input.value === '')) {
                    markInputAsInvalid(input, inputId, validation.customMessage || `${key} is required`);
                } else if (!isNaN(value)) {
                    if (validation.min !== undefined && value < validation.min) {
                        markInputAsInvalid(input, inputId, validation.customMessage || `${key} must be at least ${validation.min}`);
                    } else if (validation.max !== undefined && value > validation.max) {
                        markInputAsInvalid(input, inputId, validation.customMessage || `${key} must be at most ${validation.max}`);
                    } else {
                        markInputAsValid(input, inputId);
                    }
                }
            });
        }
        
        // Calculation functions with correct algorithms from boiler_calculator.py
        function calculateHeatingTime() {
            try {
                // Show loading state
                const resultDiv = document.getElementById('heating-result');
                const secondsDiv = document.getElementById('heating-seconds');
                if (resultDiv) resultDiv.textContent = 'Calculating...';
                if (secondsDiv) secondsDiv.textContent = '...';
                
                // Check if dissipation loss is included
                const includeDissipation = document.getElementById('ht_include_dissipation').checked;
                
                // Comprehensive validation
                const validations = {
                    initial_temp: { min: -273, max: 1000, required: true, customMessage: 'Initial temperature must be between -273¬∞C and 1000¬∞C' },
                    target_temp: { min: -273, max: 1000, required: true, customMessage: 'Target temperature must be between -273¬∞C and 1000¬∞C and greater than initial temperature' },
                    water_volume: { min: 0.001, max: 10000, required: true, customMessage: 'Water volume must be between 0.001L and 10000L' },
                    heater_power: { min: 1, max: 100000, required: true, customMessage: 'Heater power must be between 1W and 100000W' },
                    stainless_steel_volume: { min: 0.0000000001, max: 1000000000, required: true }
                };
                
                if (includeDissipation) {
                    validations.room_temp = { min: -273, max: 100, required: true };
                    validations.heat_transfer_coeff = { min: 0.1, max: 1000, required: true };
                    validations.surface_area = { min: 0.0000000001, max: 1000000000, required: true };
                }
                
                if (!validateCalculatorInputs('ht_', validations)) {
                    if (resultDiv) resultDiv.textContent = '-';
                    if (secondsDiv) secondsDiv.textContent = '-';
                    return;
                }
                
                // Additional logical validation
                const initialTemp = parseFloat(document.getElementById('ht_initial_temp').value);
                const targetTemp = parseFloat(document.getElementById('ht_target_temp').value);
                if (targetTemp <= initialTemp) {
                    showNotification('Target temperature must be greater than initial temperature', 'error');
                    document.getElementById('ht_target_temp').focus();
                    if (resultDiv) resultDiv.textContent = '-';
                    if (secondsDiv) secondsDiv.textContent = '-';
                    return;
                }
                
                const params = getCalculatorParams('ht_');
                
                // Override with normalized values for surface area and volume
                params.ht_surface_area = includeDissipation ? getNormalizedSurfaceArea('ht') : 0;
                params.ht_stainless_steel_volume = getNormalizedVolume('ht');
                
                // If dissipation not included, set default values
                if (!includeDissipation) {
                    params.ht_heat_transfer_coeff = 0;
                    params.ht_room_temp = 0;
                }
                
                // Constants from Python code
                const WATER_SPECIFIC_HEAT = 4186;  // J/(kg¬∑¬∞C)
                const WATER_DENSITY = 1.0;  // kg/L
                const STAINLESS_STEEL_DENSITY = 8000;  // kg/m¬≥
                const STAINLESS_STEEL_SPECIFIC_HEAT = 500;  // J/(kg¬∑¬∞C)
                
                // Calculate masses
                const water_mass = params.ht_water_volume * WATER_DENSITY;  // kg
                const stainless_steel_mass = params.ht_stainless_steel_volume * STAINLESS_STEEL_DENSITY;  // kg
                
                // Calculate time using numerical approximation (same as Python)
                const time_step = 0.1;  // seconds
                let current_temp = params.ht_initial_temp;
                let total_time = 0;
                
                while (current_temp < params.ht_target_temp && total_time < 3600) {  // limit to 1 hour
                    // Calculate heat loss using heat transfer coefficient and surface area (0 if dissipation not included)
                    const heat_loss = includeDissipation 
                        ? params.ht_heat_transfer_coeff * params.ht_surface_area * (current_temp - params.ht_room_temp)
                        : 0;
                    
                    // Calculate energy input from heater for this time step
                    const energy_input = params.ht_heater_power * time_step;  // Joules
                    
                    // Calculate energy lost to environment in this time step
                    const energy_lost = heat_loss * time_step;  // Joules
                    
                    // Calculate temperature change from net energy
                    const delta_temp = (energy_input - energy_lost) / (water_mass * WATER_SPECIFIC_HEAT + stainless_steel_mass * STAINLESS_STEEL_SPECIFIC_HEAT);
                    current_temp += delta_temp;
                    total_time += time_step;
                }
                
                // Format results (same as Python)
                let formatted_result, seconds_result;
                if (total_time >= 3600) {
                    formatted_result = "Over 1 hour";
                    seconds_result = "> 3600";
                } else {
                    const minutes = Math.floor(total_time / 60);
                    const seconds = Math.floor(total_time % 60);
                    formatted_result = `${minutes}m ${seconds}s`;
                    seconds_result = total_time.toFixed(1);
                }
                
                // Update result fields
                document.getElementById('heating-result').textContent = formatted_result;
                document.getElementById('heating-seconds').textContent = seconds_result;
                
            } catch (error) {
                console.error('Calculation error:', error);
                showNotification('Calculation error: ' + error.message, 'error');
            }
        }

        function calculatePower() {
            try {
                // Show loading state
                const resultDivs = ['total-power', 'power-to-water', 'power-to-steel', 'power-lost', 'instant-power'];
                resultDivs.forEach(id => {
                    const div = document.getElementById(id);
                    if (div) div.textContent = 'Calculating...';
                });
                
                // Check if dissipation loss is included
                const includeDissipation = document.getElementById('pc_include_dissipation').checked;
                
                // Comprehensive validation
                const validations = {
                    initial_temp: { min: -273, max: 1000, required: true },
                    target_temp: { min: -273, max: 1000, required: true },
                    water_volume: { min: 0.001, max: 10000, required: true },
                    time_required: { min: 1, max: 86400, required: true, customMessage: 'Time required must be between 1 second and 24 hours (86400 seconds)' },
                    stainless_steel_volume: { min: 0.0000000001, max: 1000000000, required: true }
                };
                
                if (includeDissipation) {
                    validations.room_temp = { min: -273, max: 100, required: true };
                    validations.heat_transfer_coeff = { min: 0.1, max: 1000, required: true };
                    validations.surface_area = { min: 0.0000000001, max: 1000000000, required: true };
                }
                
                if (!validateCalculatorInputs('pc_', validations)) {
                    resultDivs.forEach(id => {
                        const div = document.getElementById(id);
                        if (div) div.textContent = '-';
                    });
                    return;
                }
                
                // Additional logical validation
                const initialTemp = parseFloat(document.getElementById('pc_initial_temp').value);
                const targetTemp = parseFloat(document.getElementById('pc_target_temp').value);
                if (targetTemp <= initialTemp) {
                    showNotification('Target temperature must be greater than initial temperature', 'error');
                    document.getElementById('pc_target_temp').focus();
                    resultDivs.forEach(id => {
                        const div = document.getElementById(id);
                        if (div) div.textContent = '-';
                    });
                    return;
                }
                
                const params = getCalculatorParams('pc_');
                
                // Override with normalized values for surface area and volume
                params.pc_surface_area = includeDissipation ? getNormalizedSurfaceArea('pc') : 0;
                params.pc_stainless_steel_volume = getNormalizedVolume('pc');
                
                // If dissipation not included, set default values
                if (!includeDissipation) {
                    params.pc_heat_transfer_coeff = 0;
                    params.pc_room_temp = 0;
                }
                
                // Constants from Python code
                const WATER_SPECIFIC_HEAT = 4186;  // J/(kg¬∑¬∞C)
                const WATER_DENSITY = 1.0;  // kg/L
                const STAINLESS_STEEL_DENSITY = 8000;  // kg/m¬≥
                const STAINLESS_STEEL_SPECIFIC_HEAT = 500;  // J/(kg¬∑¬∞C)
                
                // Calculate masses
                const water_mass = params.pc_water_volume * WATER_DENSITY;  // kg
                const stainless_steel_mass = params.pc_stainless_steel_volume * STAINLESS_STEEL_DENSITY;  // kg
                
                // Use numerical approximation to calculate power requirements (same as Python)
                const time_step = 0.1;  // seconds
                
                const total_energy_to_water = (water_mass * WATER_SPECIFIC_HEAT) * (params.pc_target_temp - params.pc_initial_temp);
                const total_energy_to_steel = (stainless_steel_mass * STAINLESS_STEEL_SPECIFIC_HEAT) * (params.pc_target_temp - params.pc_initial_temp);
                const first_estimate_total_energy_lost = includeDissipation 
                    ? params.pc_time_required * params.pc_heat_transfer_coeff * params.pc_surface_area * ((params.pc_target_temp + params.pc_initial_temp)/2 - params.pc_room_temp)
                    : 0;
                const first_estimate_total_energy = total_energy_to_water + total_energy_to_steel + first_estimate_total_energy_lost;
                let first_estimate_total_power = first_estimate_total_energy / params.pc_time_required;
                
                // Iterative calculation (same as Python)
                let number_of_iterations = 0;
                let total_energy_lost = 0; // Define this variable outside the loop
                while (number_of_iterations < 10) {
                    let current_temp = params.pc_initial_temp;
                    total_energy_lost = 0; // Reset for each iteration
                    let simulation_time = 0;
                    
                    while (simulation_time < params.pc_time_required && current_temp < params.pc_target_temp) {
                        // Calculate heat loss at current temperature (0 if dissipation not included)
                        const heat_loss = includeDissipation 
                            ? params.pc_heat_transfer_coeff * params.pc_surface_area * (current_temp - params.pc_room_temp)
                            : 0;
                        total_energy_lost += heat_loss * time_step;
                        
                        // Calculate temperature change from net energy
                        const delta_temp = (first_estimate_total_power * time_step - heat_loss * time_step) / (water_mass * WATER_SPECIFIC_HEAT + stainless_steel_mass * STAINLESS_STEEL_SPECIFIC_HEAT);
                        current_temp += delta_temp;
                        
                        // Update simulation time
                        simulation_time += time_step;
                    }
                    first_estimate_total_power = (total_energy_to_water + total_energy_to_steel + total_energy_lost) / params.pc_time_required;
                    number_of_iterations++;
                }
                
                // Calculate average powers (same as Python)
                const power_to_water = total_energy_to_water / params.pc_time_required;  // Watts
                const power_to_steel = total_energy_to_steel / params.pc_time_required;  // Watts
                const power_lost = total_energy_lost / params.pc_time_required;  // Watts
                const total_power = power_to_water + power_to_steel + power_lost;  // Watts
                
                // Convert to W/h for display (same as Python)
                const hours = params.pc_time_required / 3600;  // convert seconds to hours
                const total_power_per_hour = total_power * hours;
                const power_to_water_per_hour = power_to_water * hours;
                const power_to_steel_per_hour = power_to_steel * hours;
                const power_lost_per_hour = power_lost * hours;
                
                // Update result fields
                document.getElementById('total-power').textContent = total_power_per_hour.toFixed(1);
                document.getElementById('power-to-water').textContent = power_to_water_per_hour.toFixed(1);
                document.getElementById('power-to-steel').textContent = power_to_steel_per_hour.toFixed(1);
                document.getElementById('power-lost').textContent = power_lost_per_hour.toFixed(1);
                document.getElementById('instant-power').textContent = total_power.toFixed(1);
                
            } catch (error) {
                console.error('Calculation error:', error);
                showNotification('Calculation error: ' + error.message, 'error');
            }
        }

        function calculateCoolingTime() {
            try {
                // Show loading state
                const resultDiv = document.getElementById('cooling-result');
                const secondsDiv = document.getElementById('cooling-seconds');
                if (resultDiv) resultDiv.textContent = 'Calculating...';
                if (secondsDiv) secondsDiv.textContent = '...';
                
                // Comprehensive validation (dissipation always included for cooling)
                if (!validateCalculatorInputs('ct_', {
                    initial_temp: { min: -273, max: 1000, required: true },
                    final_temp: { min: -273, max: 1000, required: true },
                    water_volume: { min: 0.001, max: 10000, required: true },
                    stainless_steel_volume: { min: 0.0000000001, max: 1000000000, required: true },
                    room_temp: { min: -273, max: 100, required: true },
                    heat_transfer_coeff: { min: 0.1, max: 1000, required: true },
                    surface_area: { min: 0.0000000001, max: 1000000000, required: true }
                })) {
                    if (resultDiv) resultDiv.textContent = '-';
                    if (secondsDiv) secondsDiv.textContent = '-';
                    return;
                }
                
                // Additional logical validation
                const initialTemp = parseFloat(document.getElementById('ct_initial_temp').value);
                const finalTemp = parseFloat(document.getElementById('ct_final_temp').value);
                const roomTemp = parseFloat(document.getElementById('ct_room_temp').value);
                
                if (finalTemp >= initialTemp) {
                    showNotification('Final temperature must be less than initial temperature', 'error');
                    document.getElementById('ct_final_temp').focus();
                    if (resultDiv) resultDiv.textContent = '-';
                    if (secondsDiv) secondsDiv.textContent = '-';
                    return;
                }
                
                if (finalTemp < roomTemp) {
                    showNotification('Final temperature cannot be less than ambient temperature', 'error');
                    document.getElementById('ct_final_temp').focus();
                    if (resultDiv) resultDiv.textContent = '-';
                    if (secondsDiv) secondsDiv.textContent = '-';
                    return;
                }
                
                const params = getCalculatorParams('ct_');
                
                // Override with normalized values for surface area and volume
                params.ct_surface_area = getNormalizedSurfaceArea('ct');
                params.ct_stainless_steel_volume = getNormalizedVolume('ct');
                
                // Constants from Python code
                const WATER_SPECIFIC_HEAT = 4186;  // J/(kg¬∑¬∞C)
                const WATER_DENSITY = 1.0;  // kg/L
                const STAINLESS_STEEL_DENSITY = 8000;  // kg/m¬≥
                const STAINLESS_STEEL_SPECIFIC_HEAT = 500;  // J/(kg¬∑¬∞C)
                
                // Calculate masses
                const water_mass = params.ct_water_volume * WATER_DENSITY;  // kg
                const stainless_steel_mass = params.ct_stainless_steel_volume * STAINLESS_STEEL_DENSITY;  // kg
                
                // Calculate time using numerical approximation (same as Python)
                const time_step = 0.1;  // seconds
                let current_temp = params.ct_initial_temp;
                let total_time = 0;
                let total_energy_lost = 0;  // Track total energy lost
                let total_energy_lost_water = 0;  // Track energy lost from water
                let total_energy_lost_steel = 0;  // Track energy lost from stainless steel
                
                while (current_temp > params.ct_final_temp && total_time < 10800) {  // limit to 3 hours
                    // Calculate heat loss using heat transfer coefficient and surface area
                    const heat_loss = params.ct_heat_transfer_coeff * params.ct_surface_area * (current_temp - params.ct_room_temp);
                    
                    // Calculate energy lost to environment in this time step
                    const energy_lost = heat_loss * time_step;  // Joules
                    total_energy_lost += energy_lost;  // Accumulate total energy lost
                    
                    // Calculate temperature change from energy lost
                    const delta_temp = energy_lost / (water_mass * WATER_SPECIFIC_HEAT + stainless_steel_mass * STAINLESS_STEEL_SPECIFIC_HEAT);
                    current_temp -= delta_temp;  // Decrease current temperature
                    total_time += time_step;
                }
                
                // Calculate Total Power Lost (W/H) (same as Python)
                const delta_temp = params.ct_initial_temp - current_temp;
                const total_power_lost_water = delta_temp * (water_mass * WATER_SPECIFIC_HEAT) / 3600;
                const total_power_lost_steel = delta_temp * (stainless_steel_mass * STAINLESS_STEEL_SPECIFIC_HEAT) / 3600;
                const total_power_lost = total_power_lost_water + total_power_lost_steel;
                
                // Format results (same as Python)
                let formatted_result, seconds_result;
                if (total_time >= 10800) {
                    formatted_result = "Over 3 hours";
                    seconds_result = "> 10800";
                } else {
                    const minutes = Math.floor(total_time / 60);
                    const seconds = Math.floor(total_time % 60);
                    formatted_result = `${minutes}m ${seconds}s`;
                    seconds_result = total_time.toFixed(1);
                }
                
                // Update result fields
                document.getElementById('cooling-result').textContent = formatted_result;
                document.getElementById('cooling-seconds').textContent = seconds_result;
                document.getElementById('cooling-total-power-lost').textContent = total_power_lost.toFixed(1);
                document.getElementById('cooling-total-power-lost-water').textContent = total_power_lost_water.toFixed(1);
                document.getElementById('cooling-total-power-lost-steel').textContent = total_power_lost_steel.toFixed(1);
                
            } catch (error) {
                console.error('Calculation error:', error);
                showNotification('Calculation error: ' + error.message, 'error');
            }
        }

        function calculateBrewingLoss() {
            try {
                // Show loading state
                const resultDivs = ['final-temp', 'lost-temp', 'average-brewed-temp', 'initial-brewed-temp', 'final-brewed-temp', 'total-brewed-volume', 'brewing-energy-loss'];
                resultDivs.forEach(id => {
                    const div = document.getElementById(id);
                    if (div) div.textContent = 'Calculating...';
                });
                
                // Comprehensive validation
                if (!validateCalculatorInputs('br_', {
                    initial_temp: { min: 0, max: 200, required: true, customMessage: 'Initial temperature must be between 0¬∞C and 200¬∞C' },
                    water_volume: { min: 0.001, max: 10000, required: true },
                    stainless_steel_volume: { min: 0.000001, max: 10, required: true },
                    applied_heater_power: { min: 0, max: 100000, required: true },
                    brewing_flow_rate: { min: 0.1, max: 1000, required: true, customMessage: 'Flow rate must be between 0.1 ml/s and 1000 ml/s' },
                    brewing_time_duration: { min: 0.1, max: 3600, required: true, customMessage: 'Duration must be between 0.1 seconds and 1 hour' },
                    plumbing_temperature: { min: -273, max: 100, required: true }
                })) {
                    resultDivs.forEach(id => {
                        const div = document.getElementById(id);
                        if (div) div.textContent = '-';
                    });
                    return;
                }
                
                const params = getCalculatorParams('br_');
                
                // Override with normalized values for volume
                params.br_stainless_steel_volume = getNormalizedVolume('br');
                
                // Constants from Python code
                const WATER_SPECIFIC_HEAT = 4186;  // J/(kg¬∑¬∞C)
                const STEEL_SPECIFIC_HEAT = 500;   // J/(kg¬∑¬∞C)
                const WATER_DENSITY = 1.0;         // kg/L
                const STEEL_DENSITY = 8000.0;      // kg/m¬≥
                
                // Calculate masses (same as Python)
                const water_mass = params.br_water_volume * WATER_DENSITY;
                const steel_mass = params.br_stainless_steel_volume * STEEL_DENSITY;
                const total_thermal_mass = (water_mass * WATER_SPECIFIC_HEAT + steel_mass * STEEL_SPECIFIC_HEAT);
                
                // Calculate water replacement rate (kg/s) (same as Python)
                const water_flow_mass = params.br_brewing_flow_rate * WATER_DENSITY / 1000.0;  // (mL/s *Kg/L) / 1000 to get kg/s
                
                // Calculate time using numerical approximation (same as Python)
                const time_step = 0.01;  // seconds
                let current_temp = params.br_initial_temp;
                let total_time = 0;  // Track total energy lost
                let brewing_heat_loss = 0;
                let total_brewing_energy_loss = 0;
                let average_brewed_temp = 0;
                const numberofsteps = Math.floor(params.br_brewing_time_duration / time_step);
                let initial_brewed_temp = 0;
                
                while (total_time < params.br_brewing_time_duration) {
                    brewing_heat_loss = (water_flow_mass * WATER_SPECIFIC_HEAT * (current_temp - params.br_plumbing_temperature));
                    const brewing_energy_loss_step = brewing_heat_loss * time_step;
                    total_brewing_energy_loss += brewing_energy_loss_step;
                    
                    const applied_heater_energy_step = params.br_applied_heater_power * time_step;
                    
                    const delta_energy_step = applied_heater_energy_step - brewing_energy_loss_step;
                    // Calculate temperature change from energy lost and applied heater power
                    const delta_temp_step = (delta_energy_step) / (total_thermal_mass);
                    current_temp += delta_temp_step;  // update current temperature
                    
                    if (total_time === 0) {
                        initial_brewed_temp = current_temp;
                    }
                    total_time += time_step;
                    average_brewed_temp += current_temp / numberofsteps;
                }
                
                const brewing_energy_loss = (total_brewing_energy_loss / params.br_brewing_time_duration);
                
                const final_temp = current_temp;
                const lost_temp = params.br_initial_temp - final_temp;
                const final_brewed_temp = final_temp;
                
                const total_brewed_volume = (params.br_brewing_flow_rate * params.br_brewing_time_duration) / 1000.0;  // Convert mL to L
                
                // Update result fields
                document.getElementById('final-temp').textContent = final_temp.toFixed(1);
                document.getElementById('lost-temp').textContent = lost_temp.toFixed(1);
                document.getElementById('average-brewed-temp').textContent = average_brewed_temp.toFixed(1);
                document.getElementById('initial-brewed-temp').textContent = initial_brewed_temp.toFixed(1);
                document.getElementById('final-brewed-temp').textContent = final_brewed_temp.toFixed(1);
                document.getElementById('total-brewed-volume').textContent = total_brewed_volume.toFixed(1);
                document.getElementById('brewing-energy-loss').textContent = brewing_energy_loss.toFixed(1);
                
            } catch (error) {
                console.error('Calculation error:', error);
                showNotification('Calculation error: ' + error.message, 'error');
            }
        }

        function getCalculatorParams(prefix) {
            const params = {};
            Object.keys(defaultValues).forEach(key => {
                if (key.startsWith(prefix)) {
                    const input = document.getElementById(key);
                    if (input) {
                        params[key] = parseFloat(input.value) || 0;
                    }
                }
            });
            return params;
        }



        // Simple Calculator (from previous implementation)
        class Calculator {
            constructor() {
                this.previousOperand = '';
                this.currentOperand = '0';
                this.operation = undefined;
            }

            clear() {
                this.currentOperand = '0';
                this.previousOperand = '';
                this.operation = undefined;
            }

            delete() {
                if (this.currentOperand === '0') return;
                this.currentOperand = this.currentOperand.toString().slice(0, -1);
                if (this.currentOperand === '') this.currentOperand = '0';
            }

            appendNumber(number) {
                if (number === '.' && this.currentOperand.includes('.')) return;
                if (this.currentOperand === '0' && number !== '.') {
                    this.currentOperand = number.toString();
                } else {
                    this.currentOperand = this.currentOperand.toString() + number.toString();
                }
            }

            chooseOperation(operation) {
                if (this.currentOperand === '0') return;
                if (this.previousOperand !== '') {
                    this.compute();
                }
                this.operation = operation;
                this.previousOperand = this.currentOperand;
                this.currentOperand = '0';
            }

            compute() {
                let computation;
                const prev = parseFloat(this.previousOperand);
                const current = parseFloat(this.currentOperand);
                if (isNaN(prev) || isNaN(current)) return;

                switch (this.operation) {
                    case '+':
                        computation = prev + current;
                        break;
                    case '-':
                        computation = prev - current;
                        break;
                    case '√ó':
                        computation = prev * current;
                        break;
                    case '√∑':
                        if (current === 0) {
                            showNotification('Cannot divide by zero!', 'error');
                            return;
                        }
                        computation = prev / current;
                        break;
                    case '%':
                        computation = prev % current;
                        break;
                    default:
                        return;
                }

                this.currentOperand = computation;
                this.operation = undefined;
                this.previousOperand = '';
            }

            getDisplayNumber(number) {
                const stringNumber = number.toString();
                const integerDigits = parseFloat(stringNumber.split('.')[0]);
                const decimalDigits = stringNumber.split('.')[1];
                let integerDisplay;
                
                if (isNaN(integerDigits)) {
                    integerDisplay = '';
                } else {
                    integerDisplay = integerDigits.toLocaleString('it-IT', {
                        maximumFractionDigits: 0
                    });
                }
                
                if (decimalDigits != null) {
                    return `${integerDisplay}.${decimalDigits}`;
                } else {
                    return integerDisplay;
                }
            }

            updateDisplay() {
                document.getElementById('current-operand').innerText = this.getDisplayNumber(this.currentOperand);
                if (this.operation != null) {
                    document.getElementById('previous-operand').innerText = 
                        `${this.getDisplayNumber(this.previousOperand)} ${this.operation}`;
                } else {
                    document.getElementById('previous-operand').innerText = '';
                }
            }
        }

        const calculator = new Calculator();

        // Simple calculator functions
        function clearAll() {
            calculator.clear();
            calculator.updateDisplay();
        }

        function deleteLast() {
            calculator.delete();
            calculator.updateDisplay();
        }

        function appendNumber(number) {
            calculator.appendNumber(number);
            calculator.updateDisplay();
        }

        function appendDecimal() {
            calculator.appendNumber('.');
            calculator.updateDisplay();
        }

        function chooseOperation(operation) {
            calculator.chooseOperation(operation);
            calculator.updateDisplay();
        }

        function compute() {
            calculator.compute();
            calculator.updateDisplay();
        }

        // Keyboard support
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            
            if (key >= '0' && key <= '9') {
                appendNumber(key);
            } else if (key === '.') {
                appendDecimal();
            } else if (key === '+') {
                chooseOperation('+');
            } else if (key === '-') {
                chooseOperation('-');
            } else if (key === '*') {
                chooseOperation('√ó');
            } else if (key === '/') {
                event.preventDefault();
                chooseOperation('√∑');
            } else if (key === '%') {
                chooseOperation('%');
            } else if (key === 'Enter' || key === '=') {
                compute();
            } else if (key === 'Backspace') {
                deleteLast();
            } else if (key === 'Escape') {
                clearAll();
            }
        });

        // Initialize unit tracking
        function initializeUnits() {
            // Initialize all surface area fields to m2
            ['ht', 'pc', 'ct'].forEach(prefix => {
                const surfaceInput = document.getElementById(prefix + '_surface_area');
                if (surfaceInput) {
                    surfaceInput.dataset.currentUnit = 'm2';
                }
            });
            
            // Initialize all volume fields to m3
            ['ht', 'pc', 'ct', 'br'].forEach(prefix => {
                const volumeInput = document.getElementById(prefix + '_stainless_steel_volume');
                if (volumeInput) {
                    volumeInput.dataset.currentUnit = 'm3';
                }
            });
        }

        // PWA functionality

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        
        // Offline indicator
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            let indicator = document.getElementById('offline-indicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.setAttribute('role', 'status');
                indicator.setAttribute('aria-live', 'polite');
                indicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 12px 24px;
                    border-radius: 25px;
                    z-index: 10000;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    transition: all 0.3s ease;
                    display: none;
                `;
                document.body.appendChild(indicator);
            }
            
            if (!isOnline) {
                indicator.textContent = 'üî¥ Offline mode - Some features may be limited';
                indicator.style.background = '#e74c3c';
                indicator.style.color = 'white';
                indicator.style.display = 'block';
            } else {
                indicator.textContent = 'üü¢ Connesso';
                indicator.style.background = '#27ae60';
                indicator.style.color = 'white';
                indicator.style.display = 'block';
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Check on load

        // Dark Mode Functionality
        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedMode === 'true' || (savedMode === null && prefersDark)) {
                document.body.classList.add('dark-mode');
                updateDarkModeIcon(true);
            } else {
                document.body.classList.remove('dark-mode');
                updateDarkModeIcon(false);
            }
        }
        
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark.toString());
            updateDarkModeIcon(isDark);
            showNotification(isDark ? 'Dark mode activated' : 'Light mode activated', 'info');
        }
        
        function updateDarkModeIcon(isDark) {
            const icon = document.getElementById('dark-mode-icon');
            if (icon) {
                icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('darkMode')) {
                    if (e.matches) {
                        document.body.classList.add('dark-mode');
                        updateDarkModeIcon(true);
                    } else {
                        document.body.classList.remove('dark-mode');
                        updateDarkModeIcon(false);
                    }
                }
            });
        }
        
        // Initialize dark mode on load
        initDarkMode();
        
        // Export to CSV Functions
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }
            
            try {
                // Convert data to CSV format
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => 
                        headers.map(header => {
                            const value = row[header];
                            // Escape commas and quotes, wrap in quotes if contains special chars
                            if (value === null || value === undefined) return '';
                            const stringValue = String(value);
                            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                                return `"${stringValue.replace(/"/g, '""')}"`;
                            }
                            return stringValue;
                        }).join(',')
                    )
                ].join('\n');
                
                // Add BOM for UTF-8 to support Excel
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('CSV file exported successfully', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }
        
        function exportHeatingResults() {
            try {
                const result = document.getElementById('heating-result').textContent;
                const seconds = document.getElementById('heating-seconds').textContent;
                
                if (!result || result === '-' || result === 'Calculating...' || result === '') {
                    showNotification('Please run a calculation first', 'error');
                    return;
                }
                
                const data = [{
                    'Calculator': 'Heating Time Calculator',
                    'Initial Temperature (¬∞C)': document.getElementById('ht_initial_temp').value,
                    'Target Temperature (¬∞C)': document.getElementById('ht_target_temp').value,
                    'Water Volume (L)': document.getElementById('ht_water_volume').value,
                    'Heater Power (W)': document.getElementById('ht_heater_power').value,
                    'Ambient Temperature (¬∞C)': document.getElementById('ht_room_temp').value,
                    'Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)': document.getElementById('ht_heat_transfer_coeff').value,
                    'Surface Area': document.getElementById('ht_surface_area').value + ' ' + document.getElementById('ht_surface_area_unit').value,
                    'Stainless Steel Volume': document.getElementById('ht_stainless_steel_volume').value + ' ' + document.getElementById('ht_stainless_steel_volume_unit').value,
                    'Estimated Time': result,
                    'Time in Seconds': seconds,
                    'Calculation Date': new Date().toLocaleString('en-US')
                }];
                
                exportToCSV(data, `heating_time_${Date.now()}.csv`);
            } catch (error) {
                console.error('Export heating error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }
        
        function exportPowerResults() {
            try {
                const totalPower = document.getElementById('total-power').textContent;
                const instantPower = document.getElementById('instant-power').textContent;
                
                if (!totalPower || totalPower === '-' || totalPower === 'Calculating...' || totalPower === '') {
                    showNotification('Please run a calculation first', 'error');
                    return;
                }
                
                const data = [{
                    'Calculator': 'Power Calculator',
                    'Initial Temperature (¬∞C)': document.getElementById('pc_initial_temp').value,
                    'Target Temperature (¬∞C)': document.getElementById('pc_target_temp').value,
                    'Water Volume (L)': document.getElementById('pc_water_volume').value,
                    'Time Required (s)': document.getElementById('pc_time_required').value,
                    'Ambient Temperature (¬∞C)': document.getElementById('pc_room_temp').value,
                    'Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)': document.getElementById('pc_heat_transfer_coeff').value,
                    'Surface Area': document.getElementById('pc_surface_area').value + ' ' + document.getElementById('pc_surface_area_unit').value,
                    'Stainless Steel Volume': document.getElementById('pc_stainless_steel_volume').value + ' ' + document.getElementById('pc_stainless_steel_volume_unit').value,
                    'Total Power Required (W/h)': totalPower,
                    'Power to Water (W/h)': document.getElementById('power-to-water').textContent,
                    'Power to Steel (W/h)': document.getElementById('power-to-steel').textContent,
                    'Power Lost (W/h)': document.getElementById('power-lost').textContent,
                    'Instantaneous Power Required (W)': instantPower,
                    'Calculation Date': new Date().toLocaleString('en-US')
                }];
                
                exportToCSV(data, `power_calculation_${Date.now()}.csv`);
            } catch (error) {
                console.error('Export power error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }
        
        function exportCoolingResults() {
            try {
                const result = document.getElementById('cooling-result').textContent;
                const seconds = document.getElementById('cooling-seconds').textContent;
                
                if (!result || result === '-' || result === 'Calculating...' || result === '') {
                    showNotification('Please run a calculation first', 'error');
                    return;
                }
                
                const data = [{
                    'Calculator': 'Cooling Time Calculator',
                    'Initial Temperature (¬∞C)': document.getElementById('ct_initial_temp').value,
                    'Final Temperature (¬∞C)': document.getElementById('ct_final_temp').value,
                    'Water Volume (L)': document.getElementById('ct_water_volume').value,
                    'Ambient Temperature (¬∞C)': document.getElementById('ct_room_temp').value,
                    'Heat Transfer Coefficient (W/m¬≤¬∑¬∞C)': document.getElementById('ct_heat_transfer_coeff').value,
                    'Surface Area': document.getElementById('ct_surface_area').value + ' ' + document.getElementById('ct_surface_area_unit').value,
                    'Stainless Steel Volume': document.getElementById('ct_stainless_steel_volume').value + ' ' + document.getElementById('ct_stainless_steel_volume_unit').value,
                    'Estimated Time': result,
                    'Time in Seconds': seconds,
                    'Total Power Lost (W/h)': document.getElementById('cooling-total-power-lost').textContent,
                    'Power Lost Water (W/h)': document.getElementById('cooling-total-power-lost-water').textContent,
                    'Power Lost Steel (W/h)': document.getElementById('cooling-total-power-lost-steel').textContent,
                    'Calculation Date': new Date().toLocaleString('en-US')
                }];
                
                exportToCSV(data, `cooling_time_${Date.now()}.csv`);
            } catch (error) {
                console.error('Export cooling error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }
        
        function exportBrewingResults() {
            try {
                const finalTemp = document.getElementById('final-temp').textContent;
                
                if (!finalTemp || finalTemp === '-' || finalTemp === 'Calculating...' || finalTemp === '') {
                    showNotification('Please run a calculation first', 'error');
                    return;
                }
                
                const data = [{
                    'Calculator': 'Brewing Loss Calculator',
                    'Initial Temperature (¬∞C)': document.getElementById('br_initial_temp').value,
                    'Water Volume (L)': document.getElementById('br_water_volume').value,
                    'Stainless Steel Volume': document.getElementById('br_stainless_steel_volume').value + ' ' + document.getElementById('br_stainless_steel_volume_unit').value,
                    'Applied Heater Power (W)': document.getElementById('br_applied_heater_power').value,
                    'Brewing Flow Rate (ml/s)': document.getElementById('br_brewing_flow_rate').value,
                    'Brewing Duration (s)': document.getElementById('br_brewing_time_duration').value,
                    'Plumbing Temperature (¬∞C)': document.getElementById('br_plumbing_temperature').value,
                    'Final Boiler Temperature (¬∞C)': finalTemp,
                    'Temperature Loss (¬∞C)': document.getElementById('lost-temp').textContent,
                    'Average Brewed Temperature (¬∞C)': document.getElementById('average-brewed-temp').textContent,
                    'Initial Brewed Temperature (¬∞C)': document.getElementById('initial-brewed-temp').textContent,
                    'Final Brewed Temperature (¬∞C)': document.getElementById('final-brewed-temp').textContent,
                    'Total Brewed Volume (L)': document.getElementById('total-brewed-volume').textContent,
                    'Brewing Energy Loss (W)': document.getElementById('brewing-energy-loss').textContent,
                    'Calculation Date': new Date().toLocaleString('en-US')
                }];
                
                exportToCSV(data, `brewing_loss_${Date.now()}.csv`);
            } catch (error) {
                console.error('Export brewing error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }
        
        function exportTempProbeResults() {
            try {
                const resultValue = document.getElementById('tp_result_value').textContent;
                
                if (!resultValue || resultValue === '-' || resultValue === '') {
                    showNotification('Please run a calculation first', 'error');
                    return;
                }
                
                const inputType = document.getElementById('tp_input_type').value;
                const probeType = document.getElementById('tp_probe_type').value;
                const inputValue = inputType === 'temperature' 
                    ? document.getElementById('tp_temperature').value
                    : document.getElementById('tp_resistance').value;
                
                const data = [{
                    'Calculator': 'Temperature Probe Calculator',
                    'Probe Type': probeType === 'ntc3k3' ? 'NTC 3.3kŒ© @ 100¬∞C' : 'PT1000 (1000Œ© @ 0¬∞C)',
                    'Input Type': inputType === 'temperature' ? 'Temperature ‚Üí Resistance' : 'Resistance ‚Üí Temperature',
                    'Input Value': inputValue + (inputType === 'temperature' ? ' ¬∞C' : ' Œ©'),
                    'Result Label': document.getElementById('tp_result_label').textContent,
                    'Result Value': resultValue,
                    'Unit': document.getElementById('tp_result_unit').textContent,
                    'Information': document.getElementById('tp_result_info').textContent,
                    'Calculation Date': new Date().toLocaleString('en-US')
                }];
                
                exportToCSV(data, `temp_probe_${Date.now()}.csv`);
            } catch (error) {
                console.error('Export temp probe error:', error);
                showNotification('Export error: ' + error.message, 'error');
            }
        }

        initializeUnits();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
        }

        // iOS specific optimizations
        if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            if (window.navigator.standalone) {
                document.body.classList.add('standalone');
            }
        }

        // Allow scrolling on mobile devices
        document.body.addEventListener('touchmove', function(e) {
            // Allow all touch movements for scrolling
        }, { passive: true });

        // Toggle dissipation loss fields
        function toggleDissipationFields(prefix) {
            const checkbox = document.getElementById(prefix + '_include_dissipation');
            const group = document.getElementById(prefix + '_dissipation_group');
            
            if (checkbox && group) {
                if (checkbox.checked) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            }
        }
        
        // Temperature Probe Calculator Functions
        function toggleInputFields() {
            const inputType = document.getElementById('tp_input_type').value;
            const probeType = document.getElementById('tp_probe_type').value;
            const tempGroup = document.getElementById('temp_input_group');
            const resistanceGroup = document.getElementById('resistance_input_group');
            
            if (inputType === 'temperature') {
                tempGroup.style.display = 'block';
                resistanceGroup.style.display = 'none';
                document.getElementById('tp_temperature').value = '';
                document.getElementById('tp_resistance').value = '';
            } else {
                tempGroup.style.display = 'none';
                resistanceGroup.style.display = 'block';
                document.getElementById('tp_temperature').value = '';
                document.getElementById('tp_resistance').value = '';
            }
            
            // Update limits display when switching input types
            const probeInfo = window.getProbeData(probeType);
            updateLimitsDisplay(probeInfo, inputType);
            
            // Hide result when switching input types
            document.getElementById('tempprobe-result').style.display = 'none';
        }

        function calculateTempProbe() {
            // Check if required elements exist
            const inputTypeElement = document.getElementById('tp_input_type');
            const probeTypeElement = document.getElementById('tp_probe_type');
            const resultDiv = document.getElementById('tempprobe-result');
            const resultLabel = document.getElementById('tp_result_label');
            const resultValue = document.getElementById('tp_result_value');
            const resultUnit = document.getElementById('tp_result_unit');
            const resultInfo = document.getElementById('tp_result_info');
            
            // Check if all required elements exist
            if (!inputTypeElement || !probeTypeElement || !resultDiv || !resultLabel || !resultValue || !resultUnit || !resultInfo) {
                console.error('ERROR: Required DOM elements not found');
                return;
            }
            
            const inputType = inputTypeElement.value;
            const probeType = probeTypeElement.value;
            
            // Get probe data and limits using new system
            const probeInfo = window.getProbeData(probeType);
            
            // Update limits display based on input type
            updateLimitsDisplay(probeInfo, inputType);
            
            if (!probeInfo || !window.interpolateValue) {
                resultLabel.textContent = 'Error:';
                resultValue.textContent = '';
                resultUnit.textContent = '';
                resultInfo.textContent = 'Temperature probe data not loaded';
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                if (inputType === 'temperature') {
                    // Temperature to Resistance
                    const temperature = parseFloat(document.getElementById('tp_temperature').value);
                    
                    if (isNaN(temperature)) {
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = 'Please enter a valid temperature value';
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    const result = window.interpolateValue(
                        probeInfo.temperatures,
                        probeInfo.resistances,
                        temperature, 
                        true, 
                        probeInfo.minTemp, 
                        probeInfo.maxTemp, 
                        probeInfo.minResistance, 
                        probeInfo.maxResistance
                    );
                    
                    if (typeof result === 'object' && result.error) {
                        // Range error
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = result.message;
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    if (result === null) {
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = 'Unable to calculate resistance for this temperature';
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    resultLabel.textContent = 'Resistance:';
                    resultValue.textContent = result.toFixed(2);
                    resultUnit.textContent = 'Œ©';
                    resultInfo.textContent = `At ${temperature}¬∞C, the ${getProbeDescription(probeType)} has a resistance of ${result.toFixed(2)}Œ©`;
                    
                } else {
                    // Resistance to Temperature
                    const resistance = parseFloat(document.getElementById('tp_resistance').value);
                    
                    if (isNaN(resistance)) {
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = 'Please enter a valid resistance value';
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    if (resistance <= 0) {
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = 'Resistance must be greater than 0';
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    const result = window.interpolateValue(
                        probeInfo.temperatures,
                        probeInfo.resistances,
                        resistance, 
                        false, 
                        probeInfo.minTemp, 
                        probeInfo.maxTemp, 
                        probeInfo.minResistance, 
                        probeInfo.maxResistance
                    );
                    
                    if (typeof result === 'object' && result.error) {
                        // Range error
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = result.message;
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    if (result === null) {
                        resultLabel.textContent = 'Error:';
                        resultValue.textContent = '';
                        resultUnit.textContent = '';
                        resultInfo.textContent = 'Unable to calculate temperature for this resistance value';
                        resultDiv.style.display = 'block';
                        return;
                    }
                    
                    resultLabel.textContent = 'Temperature:';
                    resultValue.textContent = result.toFixed(1);
                    resultUnit.textContent = '¬∞C';
                    resultInfo.textContent = `With a resistance of ${resistance}Œ©, the ${getProbeDescription(probeType)} indicates ${result.toFixed(1)}¬∞C`;
                }
                
                resultDiv.style.display = 'block';
                
            } catch (error) {
                resultInfo.textContent = 'Error calculating result: ' + error.message;
                resultDiv.style.display = 'block';
            }
        }

        function getProbeDescription(probeType) {
            const descriptions = {
                'ntc3k3': 'NTC 3.3kŒ© @ 100¬∞C probe',
                'pt1000': 'PT1000 probe'
            };
            return descriptions[probeType] || 'probe';
        }
        
        // Function to update limits display
        function updateLimitsDisplay(probeInfo, inputType) {
            if (!probeInfo) return;
            
            const limitsDiv = document.getElementById('tp_limits');
            const limitsText = document.getElementById('tp_limits_text');
            if (!limitsDiv || !limitsText) return;
            
            if (inputType === 'temperature') {
                // Find resistance values for min and max temperatures
                const minResistance = probeInfo.resistances[0]; // First element (min temp)
                const maxResistance = probeInfo.resistances[probeInfo.resistances.length - 1]; // Last element (max temp)
                limitsText.textContent = `Temperature range: ${probeInfo.minTemp}¬∞C (${formatResistance(minResistance)}) to ${probeInfo.maxTemp}¬∞C (${formatResistance(maxResistance)})`;
            } else {
                // For resistance mode, we need to find the actual min/max resistance values and their corresponding temperatures
                let minResistance = probeInfo.resistances[0];
                let maxResistance = probeInfo.resistances[0];
                let minResistanceTemp = probeInfo.temperatures[0];
                let maxResistanceTemp = probeInfo.temperatures[0];
                
                for (let i = 1; i < probeInfo.resistances.length; i++) {
                    if (probeInfo.resistances[i] < minResistance) {
                        minResistance = probeInfo.resistances[i];
                        minResistanceTemp = probeInfo.temperatures[i];
                    }
                    if (probeInfo.resistances[i] > maxResistance) {
                        maxResistance = probeInfo.resistances[i];
                        maxResistanceTemp = probeInfo.temperatures[i];
                    }
                }
                
                limitsText.textContent = `Resistance range: ${formatResistance(minResistance)} (${minResistanceTemp}¬∞C) to ${formatResistance(maxResistance)} (${maxResistanceTemp}¬∞C)`;
            }
            limitsDiv.style.display = 'block';
        }
        
        // Helper function to format resistance values
        function formatResistance(resistance) {
            if (resistance >= 1000) {
                return (resistance / 1000).toFixed(1) + 'kŒ©';
            } else {
                return resistance.toFixed(1) + 'Œ©';
            }
        }
        
        // Function to handle probe type changes
        function onProbeTypeChange() {
            const inputType = document.getElementById('tp_input_type').value;
            const probeType = document.getElementById('tp_probe_type').value;
            const probeInfo = window.getProbeData(probeType);
            updateLimitsDisplay(probeInfo, inputType);
            
            // Hide result when switching probe types
            document.getElementById('tempprobe-result').style.display = 'none';
        }

        function resetTempProbe() {
            document.getElementById('tp_input_type').value = 'temperature';
            document.getElementById('tp_probe_type').value = 'ntc3k3';
            document.getElementById('tp_temperature').value = '';
            document.getElementById('tp_resistance').value = '';
            document.getElementById('tempprobe-result').style.display = 'none';
            document.getElementById('tp_limits').style.display = 'none';
            toggleInputFields();
        }
        

    </script>
</body>
</html> 